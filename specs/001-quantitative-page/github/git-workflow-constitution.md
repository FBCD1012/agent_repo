# Git 工作流自动化宪法

**版本**: 1.0.0 | **批准日期**: 2025-01-27 | **最后修订**: 2025-01-27

## 核心原则

### I. 自动化优先 (Automation First)

所有 Git 操作（提交、推送、分支管理、PR 创建）必须通过自动化脚本执行，减少人工错误，提高效率。

- 所有代码变更必须通过自动化流程提交
- 禁止手动执行可能影响仓库状态的操作
- 自动化脚本必须可重复、可审计、可回滚

### II. 分支策略 (Branch Strategy)

**主分支保护**：
- `main` 分支：生产就绪代码，只能通过 PR 合并
- `develop` 分支：开发集成分支，用于合并功能分支
- 功能分支：`[编号]-[功能名]` 格式（如 `001-quantitative-page`）

**分支命名规范**：
- 功能分支：`[三位数字]-[kebab-case-name]`
- 修复分支：`fix/[编号]-[描述]`
- 重构分支：`refactor/[编号]-[描述]`
- 热修复：`hotfix/[编号]-[描述]`

### III. 提交规范 (Commit Convention)

**提交消息格式**：
```
[类型]([范围]): [简短描述]

[详细描述（可选）]

[相关 Issue/PR（可选）]
```

**类型**：
- `feat`: 新功能
- `fix`: 修复 bug
- `refactor`: 重构代码
- `docs`: 文档更新
- `style`: 代码格式调整
- `test`: 测试相关
- `chore`: 构建/工具链变更

**示例**：
```
feat(quantitative): 添加实时交易数据展示功能

- 实现 MarketDataCard 组件
- 添加数据服务模拟
- 支持自动刷新（3秒间隔）

Closes #001
```

### IV. PR 自动化 (Pull Request Automation)

**PR 创建规则**：
- 功能完成后自动创建 PR
- PR 标题：`[类型] [编号]-[功能名]: [简短描述]`
- PR 描述必须包含：
  - 功能概述
  - 变更列表
  - 测试说明
  - 相关 Issue/任务

**PR 合并规则**：
- 必须通过代码审查（可配置自动批准）
- 必须通过 CI/CD 检查
- 必须解决所有冲突
- 合并后自动删除源分支

### V. 持续重构 (Continuous Refactoring)

**重构原则**：
- 代码质量优先：发现技术债务立即重构
- 小步快跑：每次重构保持小范围，频繁提交
- 测试覆盖：重构必须保证测试通过
- 文档同步：重构后更新相关文档

**重构触发条件**：
- 代码审查发现问题
- 静态分析工具报告
- 性能瓶颈识别
- 架构改进需求

### VI. 同步策略 (Sync Strategy)

**上传（Push）规则**：
- 本地提交后自动推送到远程
- 推送前检查冲突，如有冲突自动 rebase
- 推送失败自动重试（最多 3 次）
- 推送成功后触发 CI/CD

**下载（Pull）规则**：
- 定期自动拉取远程更新（可配置间隔）
- 拉取前保存本地未提交变更
- 自动合并或 rebase（根据配置）
- 冲突时创建备份分支并通知

### VII. 冲突处理 (Conflict Resolution)

**冲突解决策略**：
- 优先使用 rebase 保持线性历史
- 复杂冲突创建备份分支
- 自动标记冲突文件，通知人工介入
- 冲突解决后自动验证并提交

### VIII. 备份与回滚 (Backup & Rollback)

**备份策略**：
- 每次重要操作前自动创建备份分支
- 备份分支命名：`backup/[时间戳]-[操作类型]`
- 保留最近 10 个备份分支
- 自动清理过期备份（30 天）

**回滚规则**：
- 支持一键回滚到任意提交
- 回滚操作必须创建新分支
- 回滚后自动创建 PR 供审查
- 禁止强制推送（除非紧急情况）

## 工作流规则

### 日常开发流程

1. **创建功能分支**：
   ```bash
   ./scripts/git/create-feature-branch.sh [功能描述]
   ```

2. **开发与提交**：
   ```bash
   ./scripts/git/auto-commit.sh [提交消息]
   ```

3. **推送与 PR**：
   ```bash
   ./scripts/git/auto-push-and-pr.sh
   ```

4. **同步更新**：
   ```bash
   ./scripts/git/auto-sync.sh
   ```

### 重构流程

1. **识别重构点**：通过代码分析或审查
2. **创建重构分支**：`refactor/[编号]-[描述]`
3. **小步重构**：每次小范围变更，立即提交
4. **测试验证**：确保所有测试通过
5. **创建 PR**：自动创建重构 PR
6. **合并后清理**：自动删除分支

### 紧急修复流程

1. **创建热修复分支**：从 `main` 创建
2. **快速修复**：最小化变更
3. **测试验证**：确保修复有效
4. **自动合并**：合并到 `main` 和 `develop`
5. **发布标记**：自动创建版本标签

## 自动化脚本要求

### 脚本职责

- **git/create-feature-branch.sh**: 创建功能分支
- **git/auto-commit.sh**: 自动提交变更
- **git/auto-push.sh**: 自动推送代码
- **git/auto-pull.sh**: 自动拉取更新
- **git/auto-pr.sh**: 自动创建 PR
- **git/auto-sync.sh**: 自动同步（pull + push）
- **git/backup-branch.sh**: 创建备份分支
- **git/rollback.sh**: 回滚操作

### 脚本质量标准

- 所有脚本必须支持 `--dry-run` 模式
- 所有脚本必须支持 `--verbose` 模式
- 所有脚本必须记录操作日志
- 所有脚本必须处理错误和异常
- 所有脚本必须提供帮助信息（`--help`）

## 配置要求

### 必需配置

- **Git 用户信息**：自动从 `.gitconfig` 读取
- **GitHub Token**：存储在环境变量或安全配置中
- **仓库 URL**：配置在 `.git/config` 或环境变量
- **分支策略**：定义在 `git-workflow-config.json`

### 可选配置

- **自动合并**：PR 自动合并开关
- **冲突策略**：merge vs rebase
- **同步间隔**：自动同步的时间间隔
- **备份保留**：备份分支保留数量

## 安全规则

### 访问控制

- GitHub Token 必须使用最小权限原则
- Token 必须定期轮换（建议 90 天）
- 敏感信息不得提交到仓库
- 使用 `.gitignore` 排除敏感文件

### 操作限制

- 禁止强制推送到受保护分支
- 禁止删除 `main` 和 `develop` 分支
- 禁止修改已发布的标签
- 批量操作需要明确确认

## 监控与审计

### 日志记录

- 所有 Git 操作必须记录日志
- 日志包含：时间、操作、用户、结果
- 日志保留至少 90 天
- 日志文件位置：`.git/workflow-logs/`

### 审计要求

- 定期审查自动化操作日志
- 检查异常操作模式
- 验证备份完整性
- 审查 PR 合并历史

## 治理

### 宪法优先级

本宪法优先于所有其他 Git 工作流实践。任何违反本宪法的操作必须：
1. 立即停止
2. 记录违规情况
3. 评估影响
4. 采取补救措施

### 修订流程

1. 提出修订建议（Issue）
2. 讨论和审查（PR）
3. 投票表决（需要 2/3 同意）
4. 更新版本号
5. 通知所有使用者

### 例外情况

紧急情况下可以临时绕过某些规则，但必须：
- 记录例外原因
- 事后审查和批准
- 更新流程防止再次发生

---

**版本历史**：
- v1.0.0 (2025-01-27): 初始版本

